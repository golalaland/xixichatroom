<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Xixi ‚Äî Money Talk üí∏</title>
<style>
  :root{--bg:#000;--card:#111;--muted:#aaa;--accent:#FF1493;--glass: rgba(255,255,255,0.03);}
  html,body{height:100%;margin:0;font-family:'XiXi',Inter,sans-serif;color:#fff;background:var(--bg);}
  #appWrapper{transform: scale(1);transform-origin: top center;width: 100%;height: 100%;display:flex;justify-content:center;}
  .app{display:flex;flex-direction:column;height:100%;gap:10px;padding:10px;box-sizing:border-box;width:100%;max-width:480px;}
  .brand{font-weight:700;font-size:24px;color:var(--accent);text-align:center;}
  .room-desc{font-size:11px;color:var(--muted);text-align:center;margin-bottom:10px;}
  #authBox{margin-bottom:10px;text-align:center;}
  #authBox button.btn{background:var(--accent);color:#000;border:0;padding:5px 10px;border-radius:8px;cursor:pointer;font-weight:600;font-size:12px;}
  #center{flex:1;display:flex;flex-direction:column;gap:4px;}
  #videoContainer{width:100%;aspect-ratio:16/9;background:#111;border-radius:10px;overflow:hidden;position:sticky;top:0;z-index:5;}
  #videoContainer iframe{width:100%;height:100%;border:0;border-radius:10px;}
  #messages{flex:1;overflow-y:auto;padding:6px;display:flex;flex-direction:column;gap:4px;border-radius:8px;background:#000;margin-bottom:4px;}
  .msg{padding:5px 6px;border-radius:8px;background:var(--glass);max-width:85%;display:flex;gap:4px;align-items:center;opacity:0;animation:fadeInUp 0.25s forwards;justify-content:flex-start;}
  .msg.me{background:rgba(255,20,147,0.1);}
  .msg .meta{font-weight:700;font-size:13px;}
  .msg .content{font-size:11px;color:#fff;white-space:pre-wrap;}
  .send-area{display:flex;align-items:center;gap:4px;background:var(--card);padding:10px;position:sticky;bottom:0;z-index:10;border-top:1px solid rgba(255,255,255,0.05);border-radius:18px;}
  .send-area input{flex:1;padding:10px;border-radius:999px;border:1px solid rgba(255,255,255,0.1);background:#111;color:#fff;font-size:13px;outline:none;}
  .send-area input::placeholder{color:var(--muted);}
  .send-area input:focus{border-color:var(--accent);box-shadow:0 0 8px rgba(255,20,147,0.4);}
  .send-area button.btn{padding:10px 16px;border-radius:999px;background:var(--accent);color:#000;cursor:pointer;font-weight:600;font-size:13px;}
  .profile{display:none;flex-direction:column;gap:3px;margin-top:10px;}
  .stats{font-size:10px;font-weight:700;color:var(--accent);}
  .stats span{font-weight:400;color:#fff;font-family:monospace;font-size:12px;}
  .profile-card{background:var(--glass);padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.05);}
  .badge{font-size:11px;margin-left:3px;background:none;color:#fff;padding:0;}
  .cash-earned .badge{display:none;}
  .admin-panel{display:none;margin-top:6px;padding:5px;background:#111;border-radius:8px;border:1px solid rgba(255,20,147,0.3);flex-direction:column;gap:3px;}
  .admin-panel button{padding:5px;background:var(--accent);color:#000;border:none;border-radius:6px;cursor:pointer;margin:1px 0;font-size:11px;}
  @keyframes fadeInUp{to{opacity:1;transform:translateY(0);}}
</style>
</head>
<body>
<div id="appWrapper">
  <div class="app">
    <div class="brand">‰πÇ‰∏®‰πÇ‰∏®</div>
    <div class="room-desc">
      Money Talk üí∏ ‚Äî Chat. Own your vibe.
      <span id="onlineCount" style="color:var(--accent);font-weight:600;"></span>
    </div>
    <div id="center">
      <div id="videoContainer">
        <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" allowfullscreen></iframe>
      </div>
      <div id="authBox">
        <button id="googleSignInBtn" class="btn">Sign in with Google</button>
      </div>
      <div id="messages"></div>
      <div class="send-area" id="sendArea" style="display:none;">
        <input type="text" id="messageInput" placeholder="Type your message..." />
        <button id="sendBtn" class="btn">Send</button>
      </div>
    </div>
    <div class="profile" id="profileBox">
      <div class="profile-card">
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <div>
            <strong id="profileName">GUEST 0000</strong>
            <div class="stats">STARS COLLECTED: <span id="starCount">0</span> <span class="badge">‚≠ê</span></div>
            <div class="stats cash-earned">CASH EARNED: <span id="cashCount">‚Ç¶0</span> <span class="badge">‚Ç¶</span></div>
          </div>
        </div>
      </div>
      <div class="admin-panel" id="adminPanel">
        <h3 style="margin:0;color:#fff;text-align:center;font-size:12px;">‚ö° Admin Dashboard ‚ö°</h3>
        <button onclick="pushAnnouncement()">Push Announcement</button>
        <button onclick="resetUserStars()">Reset Stars</button>
        <button onclick="clearChat()">Clear Chat</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getDatabase, ref, onDisconnect, onValue, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDbKz4ef_eUDlCukjmnK38sOwueYuzqoao",
  authDomain: "metaverse-1010.firebaseapp.com",
  projectId: "metaverse-1010",
  storageBucket: "metaverse-1010.firebasestorage.app",
  messagingSenderId: "1044064238233",
  appId: "1:1044064238233:web:2fbdfb811cb0a3ba349608",
  databaseURL: "https://metaverse-1010-default-rtdb.firebaseio.com/"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const rtdb = getDatabase(app);
let currentUser = null;
let userColors = {};
const dailyStarCap = 500;
const autoStarEnabled = true;

function generateGuestName(){return "GUEST " + Math.floor(1000+Math.random()*9000);}
function getColorForUser(chatId){
  if(!userColors[chatId]){
    const c=["#FF6B6B","#FF1493","#FF69B4","#FF85C0","#FF00FF"];
    userColors[chatId]=c[Math.floor(Math.random()*c.length)];
  }
  return userColors[chatId];
}

setPersistence(auth,browserLocalPersistence).catch(()=>{});

// Google sign-in
document.getElementById("googleSignInBtn").addEventListener("click",async()=>{
  const provider=new GoogleAuthProvider();
  try{await signInWithPopup(auth,provider);}catch(e){console.error(e);}
});

// Presence
const onlineCountEl = document.getElementById("onlineCount");
const presenceRef = ref(rtdb,"presence");
onValue(presenceRef,snap=>{
  const val=snap.val()||{};
  onlineCountEl.textContent = `(${Object.keys(val).length} online)`;
});

function setupPresence(user){
  const userRef = ref(rtdb,"presence/"+user.uid);
  set(userRef,true);
  onDisconnect(userRef).remove();
}

function updateAdminPanel(user){
  document.getElementById("adminPanel").style.display = user?.isAdmin ? "flex" : "none";
}

function formatNumberWithCommas(n){return new Intl.NumberFormat('en-NG').format(n);}

// Auth state
onAuthStateChanged(auth,async user=>{
  if(user){
    const userRef = doc(db,"users",user.uid);
    const snap = await getDoc(userRef);
    if(!snap.exists()){
      await setDoc(userRef,{chatId:"",email:user.email,stars:0,cash:0,isAdmin:false,lastStarReset:Date.now()});
    }
    const userData = (await getDoc(userRef)).data();
    currentUser = {uid:user.uid,...userData};
    setupPresence(user);

    document.getElementById("authBox").style.display="none";
    document.getElementById("sendArea").style.display="flex";
    document.getElementById("profileBox").style.display="flex";
    document.getElementById("profileName").innerText=currentUser.chatId||generateGuestName();

    // Listen for stars/cash/admin changes
    onSnapshot(userRef,docSnap=>{
      const d = docSnap.data()||{};
      currentUser.stars=d.stars||0;
      currentUser.cash=d.cash||0;
      currentUser.isAdmin=d.isAdmin||false;
      document.getElementById("starCount").innerText=formatNumberWithCommas(currentUser.stars);
      document.getElementById("cashCount").innerText="‚Ç¶"+formatNumberWithCommas(currentUser.cash);
      updateAdminPanel(currentUser);
    });

    // Auto star increment
    setInterval(async()=>{
      if(currentUser.stars < dailyStarCap){
        const userRef = doc(db,"users",currentUser.uid);
        await updateDoc(userRef,{stars:Math.min(currentUser.stars+1,dailyStarCap)});
      }
    },10000);

    // Listen for messages
    const q = collection(db,"messages");
    onSnapshot(q, snap => {
      const messagesDiv = document.getElementById("messages");
      snap.docChanges().forEach(change=>{
        if(change.type==='added'){
          const m = change.doc.data();
          const div = document.createElement("div");
          div.classList.add("msg");
          if(m.uid===currentUser.uid) div.classList.add("me");
          const color = getColorForUser(m.chatId||"Guest");
          div.innerHTML = `<span class="meta" style="color:${color}">${m.chatId||"Guest"}:</span> <span class="content">${m.content}</span>`;
          messagesDiv.appendChild(div);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
      });
    });

  }else{
    document.getElementById("authBox").style.display="block";
    document.getElementById("sendArea").style.display="none";
  }
});

// Send message
document.getElementById("sendBtn").addEventListener("click", async()=>{
  const val=document.getElementById("messageInput").value.trim();
  if(!val) return;
  document.getElementById("messageInput").value="";
  await addDoc(collection(db,"messages"),{
    content: val,
    uid: currentUser.uid,
    chatId: currentUser.chatId || generateGuestName(),
    timestamp: serverTimestamp()
  });
});

// Admin functions
window.pushAnnouncement = async()=>{
  const msg = prompt("Enter announcement:");
  if(!msg) return;
  await addDoc(collection(db,"messages"),{
    content: "[ANNOUNCEMENT] "+msg,
    uid: currentUser.uid,
    chatId: "ADMIN",
    timestamp: serverTimestamp()
  });
};
window.resetUserStars = async()=>{
  if(confirm("Reset your stars to 0?")){
    const userRef = doc(db,"users",currentUser.uid);
    await updateDoc(userRef,{stars:0});
  }
};
window.clearChat = async()=>{
  if(confirm("Clear all messages? This cannot be undone.")){
    alert("Implement batch deletion via Cloud Functions or loop through messages in production.");
  }
};
</script>
</body>
</html>