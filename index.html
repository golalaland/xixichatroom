<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Xixi ‚Äî Money Talk üí∏</title>
  <link rel="icon" href="data:," />
  <style>
    :root{
      --bg:#000;
      --card:#111;
      --muted:#aaa;
      --accent:#FF1493;
    }
    body{
      margin:0;
      font-family:system-ui,sans-serif;
      background:var(--bg);
      color:#fff;
    }
    .app{
      display:flex;
      flex-direction:column;
      height:100vh;
    }
    .header{
      padding:12px;
      background:var(--card);
      border-bottom:1px solid #222;
      text-align:center;
    }
    .brand{
      font-weight:bold;
      font-size:18px;
    }
    .room-desc{
      font-size:13px;
      color:var(--muted);
    }
    .online-count{
      font-size:13px;
      color:var(--accent);
      margin-top:4px;
    }
    .stats{
      display:flex;
      justify-content:center;
      gap:20px;
      padding:8px 0;
      font-size:13px;
    }
    .count{
      font-family:monospace;
      font-size:14px;
      font-weight:bold;
      color:#fff;
    }
    .chat{
      flex:1;
      overflow-y:auto;
      padding:10px;
    }
    .msg{
      margin:6px 0;
      padding:8px 12px;
      border-radius:12px;
      background:var(--card);
      font-size:14px;
      max-width:80%;
      word-wrap:break-word;
    }
    .msg.admin{
      border:1px solid var(--accent);
    }
    .input-area{
      display:flex;
      gap:6px;
      padding:10px;
      border-top:1px solid #222;
      background:var(--card);
    }
    .input-area input{
      flex:1;
      padding:8px;
      border:none;
      border-radius:8px;
      background:#222;
      color:#fff;
      font-size:14px;
    }
    .input-area button{
      background:var(--accent);
      border:none;
      border-radius:8px;
      padding:8px 12px;
      color:#fff;
      font-weight:bold;
      cursor:pointer;
    }
    .admin-tools{
      display:flex;
      gap:6px;
      padding:6px 10px;
      background:#111;
      border-top:1px solid #222;
    }
    .admin-tools button{
      flex:1;
      font-size:13px;
      padding:6px;
      border:none;
      border-radius:6px;
      background:var(--accent);
      color:#fff;
      cursor:pointer;
    }
    img.chat-media, video.chat-media{
      max-width:200px;
      max-height:200px;
      border-radius:8px;
      display:block;
      margin-top:6px;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="brand">‰πÇ‰∏®‰πÇ‰∏®</div>
      <div class="room-desc">Money Talk üí∏ ‚Äî Chat. Own your vibe.</div>
      <div id="onlineCount" class="online-count">(0 online)</div>
    </div>
    <div class="stats">
      <div>‚≠ê <span id="starCount" class="count">0</span></div>
      <div>‚Ç¶ <span id="cashCount" class="count">0</span></div>
    </div>
    <div id="chat" class="chat"></div>
    <div class="input-area">
      <input id="msgInput" placeholder="Type message..." />
      <button id="sendBtn">Send</button>
    </div>
    <div class="admin-tools" id="adminTools" style="display:none;">
      <button id="imgBtn">Upload Image</button>
      <button id="vidBtn">Upload Video</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";
    import { getDatabase, ref, onDisconnect, onValue, set, serverTimestamp as rtdbTimestamp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

    // üî• Your Firebase config
    const firebaseConfig = {
      apiKey: "YOUR_KEY",
      authDomain: "YOUR_DOMAIN",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_SENDER",
      appId: "YOUR_APPID",
      databaseURL: "YOUR_DBURL"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const rtdb = getDatabase(app);

    const chatEl = document.getElementById("chat");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");
    const adminTools = document.getElementById("adminTools");
    const logoutBtn = document.getElementById("logoutBtn");
    const imgBtn = document.getElementById("imgBtn");
    const vidBtn = document.getElementById("vidBtn");
    const onlineCountEl = document.getElementById("onlineCount");

    let currentUser = null;

    // Listen for auth changes
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        if (user.email && user.email.includes("admin")) {
          adminTools.style.display = "flex";
        }
        setupPresence(user);
        loadChat();
      } else {
        signInWithPopup(auth, new GoogleAuthProvider());
      }
    });

    // Presence tracking
    function setupPresence(user) {
      const presenceRef = ref(rtdb, "presence/" + user.uid);
      set(presenceRef, { uid: user.uid, email: user.email || null, ts: rtdbTimestamp() });
      onDisconnect(presenceRef).remove();

      const allPresenceRef = ref(rtdb, "presence");
      onValue(allPresenceRef, snap => {
        const data = snap.val();
        const count = data ? Object.keys(data).length : 0;
        onlineCountEl.textContent = `(${count} online)`;
      });
    }

    // Load chat
    function loadChat() {
      const q = query(collection(db, "messages"), orderBy("ts"));
      onSnapshot(q, snapshot => {
        chatEl.innerHTML = "";
        snapshot.forEach(doc => {
          const msg = doc.data();
          const div = document.createElement("div");
          div.className = "msg" + (msg.admin ? " admin" : "");
          if (msg.text) div.textContent = msg.text;
          if (msg.mediaUrl) {
            if (msg.mediaType === "image") {
              const img = document.createElement("img");
              img.src = msg.mediaUrl;
              img.className = "chat-media";
              div.appendChild(img);
            } else if (msg.mediaType === "video") {
              const vid = document.createElement("video");
              vid.src = msg.mediaUrl;
              vid.className = "chat-media";
              vid.controls = true;
              div.appendChild(vid);
            }
          }
          chatEl.appendChild(div);
          chatEl.scrollTop = chatEl.scrollHeight;
        });
      });
    }

    // Send text
    sendBtn.onclick = async () => {
      if (!msgInput.value.trim()) return;
      await addDoc(collection(db, "messages"), {
        text: msgInput.value,
        ts: serverTimestamp(),
        uid: currentUser.uid,
        admin: currentUser.email && currentUser.email.includes("admin")
      });
      msgInput.value = "";
    };

    // Upload helper
    async function uploadFile(file, type) {
      const fileRef = sRef(storage, `${type}s/${Date.now()}_${file.name}`);
      await uploadBytes(fileRef, file);
      return await getDownloadURL(fileRef);
    }

    // Upload image
    imgBtn.onclick = async () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (file) {
          const url = await uploadFile(file, "image");
          await addDoc(collection(db, "messages"), {
            mediaUrl: url,
            mediaType: "image",
            ts: serverTimestamp(),
            uid: currentUser.uid,
            admin: true
          });
        }
      };
      input.click();
    };

    // Upload video
    vidBtn.onclick = async () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "video/*";
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (file) {
          const url = await uploadFile(file, "video");
          await addDoc(collection(db, "messages"), {
            mediaUrl: url,
            mediaType: "video",
            ts: serverTimestamp(),
            uid: currentUser.uid,
            admin: true
          });
        }
      };
      input.click();
    };

    logoutBtn.onclick = () => signOut(auth);
  </script>
</body>
</html>